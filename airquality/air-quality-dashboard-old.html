<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Automation Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_BASE_URL = 'https://ou1jc1tszb.execute-api.us-west-1.amazonaws.com/dev';

        const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'N/A';
            return new Date(timestamp * 1000).toLocaleString();
        };

        const formatDateForAPI = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        const getDefaultDateRange = () => {
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - 7);
            return { start: formatDateForAPI(start), end: formatDateForAPI(end) };
        };

        const getAirQualityStatus = (pm25) => {
            if (pm25 === null || pm25 === undefined) return { label: 'Unknown', color: 'bg-gray-500', textColor: 'text-gray-700' };
            if (pm25 < 9) return { label: 'Good', color: 'bg-emerald-500', textColor: 'text-emerald-700' };
            if (pm25 < 35) return { label: 'Moderate', color: 'bg-yellow-500', textColor: 'text-yellow-700' };
            if (pm25 < 55) return { label: 'Unhealthy', color: 'bg-orange-500', textColor: 'text-orange-700' };
            return { label: 'Hazardous', color: 'bg-red-500', textColor: 'text-red-700' };
        };

        const api = {
            async listTuyaDevices() {
                const response = await fetch(`${API_BASE_URL}/tuya/devices`);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                return response.json();
            },
            async listDevices(userId) {
                const response = await fetch(`${API_BASE_URL}/qingping/devices?user_id=${userId}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                return response.json();
            },
            async listMappings(userId) {
                const response = await fetch(`${API_BASE_URL}/mapping/sensor-plug?user_id=${encodeURIComponent(userId)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                return response.json();
            },
            async createMapping(userId, sensorMac, tuyaDeviceId, enabled = true) {
                const response = await fetch(`${API_BASE_URL}/mapping/sensor-plug`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, sensor_mac: sensorMac, tuya_device_id: tuyaDeviceId, enabled })
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                return response.json();
            },
            async deleteMapping(sensorMac) {
                const response = await fetch(`${API_BASE_URL}/mapping/sensor-plug`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sensor_mac: sensorMac, delete: true })
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                return response.json();
            },
            async toggleMapping(userId, sensorMac, tuyaDeviceId, enabled) {
                return this.createMapping(userId, sensorMac, tuyaDeviceId, enabled);
            }
        };

        const Icon = ({ name, className = "w-5 h-5" }) => {
            const ref = React.useRef();
            useEffect(() => {
                if (ref.current) lucide.createIcons({ icons: { [name]: lucide[name] }, nameAttr: 'data-lucide', attrs: { class: className } });
            }, [name, className]);
            return <i ref={ref} data-lucide={name} className={className}></i>;
        };

        const Alert = ({ type = 'info', children }) => {
            const styles = { error: 'bg-red-50 border-red-200 text-red-800', success: 'bg-emerald-50 border-emerald-200 text-emerald-800', info: 'bg-blue-50 border-blue-200 text-blue-800', warning: 'bg-yellow-50 border-yellow-200 text-yellow-800' };
            useEffect(() => { lucide.createIcons(); }, []);
            return (
                <div className={`px-4 py-3 rounded-lg border ${styles[type]} mb-4 flex items-start gap-2 animate-fadeIn`}>
                    {type === 'error' && <Icon name="alert-circle" className="w-5 h-5 mt-0.5 flex-shrink-0" />}
                    {type === 'success' && <Icon name="check-circle" className="w-5 h-5 mt-0.5 flex-shrink-0" />}
                    <div className="flex-1">{children}</div>
                </div>
            );
        };

        const LoadingSpinner = () => (<div className="flex items-center justify-center py-8"><div className="w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div></div>);

        const SensorCard = ({ device, onMapToPug, onDownloadCSV, hasMappingExisting }) => {
            const aqStatus = device.latest_pm25 ? getAirQualityStatus(device.latest_pm25) : null;
            useEffect(() => { lucide.createIcons(); }, []);
            return (
                <div className="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200 hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
                    <div className="bg-gradient-to-br from-blue-500 to-cyan-500 px-6 py-4 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <Icon name="activity" className="w-6 h-6 text-white" />
                            <div>
                                <h3 className="text-white font-semibold text-lg">{device.device_name || device.product?.en_name || 'Air Monitor'}</h3>
                                <p className="text-blue-100 text-sm font-mono">{device.sensor_mac}</p>
                            </div>
                        </div>
                        <div className={`px-3 py-1 rounded-full text-xs font-medium ${device.enabled ? 'bg-green-400 text-green-900' : 'bg-gray-400 text-gray-900'}`}>{device.enabled ? 'Active' : 'Inactive'}</div>
                    </div>
                    <div className="p-6 space-y-4">
                        {aqStatus && (
                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div><p className="text-sm text-gray-600 mb-1">Air Quality</p><p className={`text-2xl font-bold ${aqStatus.textColor}`}>{aqStatus.label}</p></div>
                                <div className={`w-16 h-16 rounded-full ${aqStatus.color} flex items-center justify-center`}><Icon name="wind" className="w-8 h-8 text-white" /></div>
                            </div>
                        )}
                        <div className="grid grid-cols-2 gap-3">
                            <div className="text-center p-3 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg"><p className="text-xs text-gray-600 mb-1">Product</p><p className="font-mono text-sm font-semibold text-gray-900">{device.product?.code || 'N/A'}</p></div>
                            <div className="text-center p-3 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg"><p className="text-xs text-gray-600 mb-1">Bound</p><p className="font-mono text-xs text-gray-900">{formatTimestamp(device.bound_at)}</p></div>
                        </div>
                        <div className="space-y-2">
                            <button onClick={() => onMapToPug(device)} disabled={hasMappingExisting} className={`w-full py-3 px-4 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 ${hasMappingExisting ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-gradient-to-r from-blue-600 to-cyan-600 text-white hover:from-blue-700 hover:to-cyan-700 shadow-md hover:shadow-lg'}`}><Icon name="link" className="w-5 h-5" />{hasMappingExisting ? 'Already Mapped' : 'Map to Plug'}</button>
                            <button onClick={() => onDownloadCSV(device)} className="w-full py-3 px-4 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 bg-emerald-600 text-white hover:bg-emerald-700 shadow-md hover:shadow-lg"><Icon name="download" className="w-5 h-5" />Download CSV</button>
                        </div>
                    </div>
                </div>
            );
        };

        const MappingCard = ({ mapping, onToggle, onDelete }) => {
            const [isDeleting, setIsDeleting] = useState(false);
            useEffect(() => { lucide.createIcons(); }, []);
            const handleDelete = async () => {
                if (!window.confirm('Are you sure you want to delete this mapping? The sensor will no longer control the plug.')) return;
                setIsDeleting(true);
                try { await onDelete(mapping.sensor_mac); } catch (error) { setIsDeleting(false); }
            };
            return (
                <div className="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200 hover:shadow-xl transition-all duration-300">
                    <div className="bg-gradient-to-br from-purple-500 to-pink-500 px-6 py-4"><div className="flex items-center justify-between"><div className="flex items-center gap-3"><Icon name="link" className="w-6 h-6 text-white" /><div><h3 className="text-white font-semibold">Sensor-Plug Mapping</h3><p className="text-purple-100 text-sm font-mono">{mapping.sensor_mac}</p></div></div><button onClick={() => onToggle(mapping)} className={`p-2 rounded-lg transition-all duration-200 ${mapping.enabled ? 'bg-green-400 hover:bg-green-500 text-green-900' : 'bg-gray-400 hover:bg-gray-500 text-gray-900'}`}><Icon name="power" className="w-5 h-5" /></button></div></div>
                    <div className="p-6 space-y-4"><div className="space-y-2"><div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><span className="text-sm text-gray-600">Tuya Device</span><span className="font-mono text-sm font-medium text-gray-900">{mapping.tuya_device_id}</span></div><div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><span className="text-sm text-gray-600">Status</span><span className={`px-3 py-1 rounded-full text-xs font-medium ${mapping.enabled ? 'bg-green-100 text-green-800' : 'bg-gray-200 text-gray-700'}`}>{mapping.enabled ? 'Automation Active' : 'Automation Paused'}</span></div>{mapping.updated_at && (<div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><span className="text-sm text-gray-600">Last Updated</span><span className="text-xs font-mono text-gray-900">{formatTimestamp(mapping.updated_at)}</span></div>)}</div><button onClick={handleDelete} disabled={isDeleting} className="w-full py-3 px-4 rounded-lg font-medium bg-red-500 text-white hover:bg-red-600 transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"><Icon name="trash-2" className="w-5 h-5" />{isDeleting ? 'Deleting...' : 'Delete Mapping'}</button></div>
                </div>
            );
        };

        function AirQualityDashboard() {
            const [currentView, setCurrentView] = useState('devices');
            const userId = "qingping_shared";
            const [devices, setDevices] = useState([]);
            const [mappings, setMappings] = useState([]);
            const [tuyaDevices, setTuyaDevices] = useState([]);
            const [loading, setLoading] = useState(false);
            const [tuyaLoading, setTuyaLoading] = useState(false);
            const [error, setError] = useState(null);
            const [success, setSuccess] = useState(null);
            const [mapForm, setMapForm] = useState({ sensorMac: '', tuyaDeviceId: '', enabled: true });
            const [showMapForm, setShowMapForm] = useState(false);
            const [csvForm, setCsvForm] = useState({ sensorMac: '', sensorName: '', startDate: '', endDate: '' });
            const [showCsvForm, setShowCsvForm] = useState(false);
            const [csvDownloading, setCsvDownloading] = useState(false);

            useEffect(() => { lucide.createIcons(); }, [currentView, devices, mappings, showMapForm, showCsvForm, error, success]);
            useEffect(() => {
                if (currentView === 'devices') { loadDevices(); loadMappings(); }
                else if (currentView === 'mappings') { loadMappings(); }
            }, [currentView]);

            const loadDevices = async () => { setLoading(true); setError(null); try { const data = await api.listDevices(userId); setDevices(data.devices || []); } catch (err) { setError(`Failed to load devices: ${err.message}`); } finally { setLoading(false); } };
            const loadMappings = async () => { setLoading(true); setError(null); try { const data = await api.listMappings(userId); setMappings(data.mappings || []); } catch (err) { setError(`Failed to load mappings: ${err.message}`); setMappings([]); } finally { setLoading(false); } };
            const loadTuyaDevices = async () => { setTuyaLoading(true); setError(null); try { const data = await api.listTuyaDevices(); setTuyaDevices(data.devices || []); } catch (err) { setError(`Failed to load Tuya devices: ${err.message}`); setTuyaDevices([]); } finally { setTuyaLoading(false); } };
            
            const handleCreateMapping = async (e) => { e.preventDefault(); setLoading(true); setError(null); setSuccess(null); try { await api.createMapping(userId, mapForm.sensorMac, mapForm.tuyaDeviceId, mapForm.enabled); setSuccess('Mapping created successfully!'); setShowMapForm(false); setMapForm({ sensorMac: '', tuyaDeviceId: '', enabled: true }); loadDevices(); loadMappings(); } catch (err) { setError(`Failed to create mapping: ${err.message}`); } finally { setLoading(false); } };
            const handleToggleMapping = async (mapping) => { try { await api.toggleMapping(userId, mapping.sensor_mac, mapping.tuya_device_id, !mapping.enabled); setSuccess(`Mapping ${!mapping.enabled ? 'enabled' : 'disabled'} successfully!`); loadMappings(); } catch (err) { setError(`Failed to toggle mapping: ${err.message}`); } };
            const handleDeleteMapping = async (sensorMac) => { try { await api.deleteMapping(sensorMac); setSuccess('Mapping deleted successfully!'); loadMappings(); } catch (err) { setError(`Failed to delete mapping: ${err.message}`); } };
            const openMapForm = (device) => { setMapForm({ sensorMac: device.sensor_mac, tuyaDeviceId: '', enabled: true }); setShowMapForm(true); setError(null); setSuccess(null); loadTuyaDevices(); };
            const openCsvForm = (device) => { const { start, end } = getDefaultDateRange(); setCsvForm({ sensorMac: device.sensor_mac, sensorName: device.device_name || device.product?.en_name || 'Air Monitor', startDate: start, endDate: end }); setShowCsvForm(true); setError(null); setSuccess(null); };

            const handleDownloadCSV = async (e) => {
                e.preventDefault();
                if (!csvForm.startDate || !csvForm.endDate) { setError('Please select both start and end dates'); return; }
                if (csvForm.startDate > csvForm.endDate) { setError('Start date must be before or equal to end date'); return; }
                setCsvDownloading(true); setError(null); setSuccess(null);
                try {
                    const url = `${API_BASE_URL}/download/csv?sensor_mac=${encodeURIComponent(csvForm.sensorMac)}&start_time=${csvForm.startDate}&end_time=${csvForm.endDate}`;
                    const response = await fetch(url);
                    if (!response.ok) {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || `Server error: ${response.status}`);
                        } else {
                            const text = await response.text();
                            throw new Error(text || `Server returned status ${response.status}`);
                        }
                    }
                    const contentType = response.headers.get('content-type');
                    if (!contentType || (!contentType.includes('text/csv') && !contentType.includes('application/csv'))) {
                        throw new Error('Server did not return a CSV file. Got: ' + contentType);
                    }
                    const blob = await response.blob();
                    const blobUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = blobUrl;
                    a.download = `sensor_${csvForm.sensorMac}_${csvForm.startDate}_${csvForm.endDate}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => { window.URL.revokeObjectURL(blobUrl); document.body.removeChild(a); }, 100);
                    setSuccess('CSV downloaded successfully!');
                    setShowCsvForm(false);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } catch (err) { console.error('CSV download error:', err); setError(`Failed to download CSV: ${err.message}`); } finally { setCsvDownloading(false); }
            };

            const hasMappingForDevice = (sensorMac) => mappings.some(m => m.sensor_mac === sensorMac);

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-cyan-50">
                    <header className="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-10"><div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6"><div className="flex items-center justify-between"><div className="flex items-center gap-4"><div className="w-12 h-12 bg-gradient-to-br from-blue-600 to-cyan-600 rounded-xl flex items-center justify-center shadow-lg"><Icon name="wind" className="w-7 h-7 text-white" /></div><div><h1 className="text-3xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">Air Quality Automation</h1><p className="text-sm text-gray-600 font-medium">Multi-Sensor Control System</p></div></div><div className="flex items-center gap-2 px-4 py-2 bg-blue-50 rounded-lg border border-blue-200"><div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div><span className="text-sm font-mono text-blue-900">Account: qingping_shared</span></div></div></div></header>
                    <nav className="bg-white border-b border-gray-200 shadow-sm"><div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><div className="flex gap-1">{[{ id: 'devices', label: 'Devices', icon: 'activity' }, { id: 'mappings', label: 'Mappings', icon: 'link' }].map(tab => (<button key={tab.id} onClick={() => { setCurrentView(tab.id); setError(null); setSuccess(null); }} className={`flex items-center gap-2 px-6 py-4 font-medium transition-all duration-200 border-b-2 ${currentView === tab.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-600 hover:text-gray-900 hover:border-gray-300'}`}><Icon name={tab.icon} className="w-5 h-5" />{tab.label}</button>))}</div></div></nav>
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {error && <Alert type="error">{error}</Alert>}
                        {success && <Alert type="success">{success}</Alert>}
                        {currentView === 'devices' && (<div className="space-y-6"><div className="flex items-center justify-between"><h2 className="text-2xl font-bold text-gray-900">Your Devices</h2><button onClick={loadDevices} disabled={loading} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-200 disabled:opacity-50"><Icon name="refresh-cw" className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />Refresh</button></div>{loading ? <LoadingSpinner /> : devices.length === 0 ? (<div className="text-center py-16 bg-white rounded-xl shadow-sm border border-gray-200"><Icon name="activity" className="w-16 h-16 text-gray-400 mx-auto mb-4" /><h3 className="text-xl font-semibold text-gray-900 mb-2">No Devices Found</h3><p className="text-gray-600">Make sure sensors are already registered to the qingping_shared account.</p></div>) : (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{devices.map(device => (<SensorCard key={device.sensor_mac} device={device} onMapToPug={openMapForm} onDownloadCSV={openCsvForm} hasMappingExisting={hasMappingForDevice(device.sensor_mac)} />))}</div>)}</div>)}
                        {currentView === 'mappings' && (<div className="space-y-6"><div className="flex items-center justify-between"><h2 className="text-2xl font-bold text-gray-900">Sensor-Plug Mappings</h2><button onClick={loadMappings} disabled={loading} className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all duration-200 disabled:opacity-50"><Icon name="refresh-cw" className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />Refresh</button></div>{loading ? <LoadingSpinner /> : (<div className="grid grid-cols-1 md:grid-cols-2 gap-6">{mappings.map(mapping => (<MappingCard key={mapping.sensor_mac} mapping={mapping} onToggle={handleToggleMapping} onDelete={handleDeleteMapping} />))}</div>)}{!loading && mappings.length === 0 && (<div className="text-center py-16 bg-white rounded-xl shadow-sm border border-gray-200"><Icon name="link" className="w-16 h-16 text-gray-400 mx-auto mb-4" /><h3 className="text-xl font-semibold text-gray-900 mb-2">No Mappings Found</h3><p className="text-gray-600 mb-6">Create sensor-to-plug mappings from the Devices page</p><button onClick={() => setCurrentView('devices')} className="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all duration-200">Go to Devices</button></div>)}</div>)}
                        {showMapForm && (<div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"><div className="bg-gradient-to-br from-purple-600 to-pink-600 px-8 py-6"><h2 className="text-2xl font-bold text-white mb-2">Map Sensor to Plug</h2><p className="text-purple-100">Create automation mapping for air quality control</p></div><form onSubmit={handleCreateMapping} className="p-8 space-y-6"><div><label className="block text-sm font-medium text-gray-700 mb-2">Sensor MAC Address</label><input type="text" value={mapForm.sensorMac} readOnly className="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 font-mono text-gray-700" /></div><div><label className="block text-sm font-medium text-gray-700 mb-2">Tuya Device ID</label><select value={mapForm.tuyaDeviceId} onChange={(e) => setMapForm({ ...mapForm, tuyaDeviceId: e.target.value })} required disabled={tuyaLoading} className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent font-mono bg-white disabled:bg-gray-100"><option value="">{tuyaLoading ? "Loading Tuya devices..." : "Select a Tuya plug"}</option>{tuyaDevices.map(d => (<option key={d.tuya_device_id} value={d.tuya_device_id}>{(d.name || d.tuya_device_id) + (d.online === false ? " (offline)" : "")}</option>))}</select><p className="mt-2 text-sm text-gray-600">Select a registered plug.</p></div><div className="flex items-center gap-3 p-4 bg-blue-50 rounded-lg border border-blue-200"><input type="checkbox" id="enabledCheckbox" checked={mapForm.enabled} onChange={(e) => setMapForm({ ...mapForm, enabled: e.target.checked })} className="w-5 h-5 text-purple-600 rounded focus:ring-purple-500" /><label htmlFor="enabledCheckbox" className="text-sm font-medium text-gray-900">Enable automation immediately (plug will turn on when PM2.5 â‰¥ 9)</label></div><div className="flex gap-3"><button type="button" onClick={() => { setShowMapForm(false); setMapForm({ sensorMac: '', tuyaDeviceId: '', enabled: true }); }} className="flex-1 py-3 px-6 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all duration-200">Cancel</button><button type="submit" disabled={loading} className="flex-1 py-3 px-6 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-medium rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl">{loading ? 'Creating...' : 'Create Mapping'}</button></div></form></div></div>)}
                        {showCsvForm && (<div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full"><div className="bg-gradient-to-br from-emerald-600 to-teal-600 px-8 py-6"><h2 className="text-2xl font-bold text-white mb-2">Download Sensor Data</h2><p className="text-emerald-100">Export historical readings to CSV</p></div><form onSubmit={handleDownloadCSV} className="p-8 space-y-6"><div><label className="block text-sm font-medium text-gray-700 mb-2">Sensor</label><input type="text" value={`${csvForm.sensorName} (${csvForm.sensorMac})`} readOnly className="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-700" /></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-gray-700 mb-2">Start Date</label><input type="date" value={csvForm.startDate} onChange={(e) => setCsvForm({ ...csvForm, startDate: e.target.value })} required className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" /></div><div><label className="block text-sm font-medium text-gray-700 mb-2">End Date</label><input type="date" value={csvForm.endDate} onChange={(e) => setCsvForm({ ...csvForm, endDate: e.target.value })} required className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" /></div></div><div className="bg-blue-50 border border-blue-200 rounded-lg p-4"><p className="text-sm text-gray-700"><strong>Note:</strong> The CSV will include all recorded sensor variables (PM2.5, PM10, CO2, temperature, humidity, battery) for the selected date range.</p></div><div className="flex gap-3"><button type="button" onClick={() => { setShowCsvForm(false); setCsvForm({ sensorMac: '', sensorName: '', startDate: '', endDate: '' }); }} className="flex-1 py-3 px-6 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all duration-200">Cancel</button><button type="submit" disabled={csvDownloading} className="flex-1 py-3 px-6 bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-medium rounded-lg hover:from-emerald-700 hover:to-teal-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl flex items-center justify-center gap-2">{csvDownloading ? (<><div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>Downloading...</>) : (<><Icon name="download" className="w-5 h-5" />Download CSV</>)}</button></div></form></div></div>)}
                    </main>
                    <footer className="bg-white border-t border-gray-200 mt-16"><div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6"><div className="flex items-center justify-between text-sm text-gray-600"><p>Air Quality Automation System v1.0</p><div className="flex items-center gap-2"><div className="w-2 h-2 bg-green-500 rounded-full"></div><span>Backend Connected</span></div></div></div></footer>
                </div>
            );
        }
        ReactDOM.render(<AirQualityDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
